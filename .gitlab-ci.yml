---

include:
  - template: 'Workflows/MergeRequest-Pipelines.gitlab-ci.yml'

stages:
  - üèó build
  - üöö publish

variables:
  # Secrets (set in GitLab CI/CD settings)
  # - AWS IAM id/secret key for 'bas-gitlab-ci-bas-metadata-standards' user
  #   - AWS_ACCESS_KEY_ID: "[Sensitive]"
  #   - AWS_SECRET_ACCESS_KEY: "[Sensitive]"

  # Publishing
  S3_RESOURCES_BUCKET_STAGE: metadata-resources-testing.data.bas.ac.uk
  S3_RESOURCES_BUCKET_PROD: metadata-resources.data.bas.ac.uk
  S3_DOCS_BUCKET_STAGE: metadata-standards-testing.data.bas.ac.uk
  S3_DOCS_BUCKET_PROD: metadata-standards.data.bas.ac.uk

image:
  name: governmentpaas/awscli:latest
  entrypoint: [""]

build:
  stage: üèó build
  needs: []
  image: ghcr.io/astral-sh/uv:0.9.9-python3.14-trixie-slim
  before_script:
    - 'cd site/'
    - 'uv --version'
    - 'uv sync --all-groups'
  script:
    - 'uv run python src/build.py'
  artifacts:
    paths:
      - site/build
    expire_in: 1 month
  rules:
    -
      changes:
        - 'site/**/*.*'

publish-resources-stage:
  stage: üöö publish
  needs: []
  script:
    - "aws s3 sync resources/ s3://$S3_RESOURCES_BUCKET_STAGE/ --exclude '_site/*' --exclude '*/_site/*'"
    - "aws s3 sync resources/_site/ s3://$S3_RESOURCES_BUCKET_STAGE/"
  environment:
    name: resources-testing
    url: "http://$S3_RESOURCES_BUCKET_STAGE"
  rules:
    -
      changes:
        - 'resources/**/*.*'
      if: '$CI_COMMIT_BRANCH != "main" && $CI_COMMIT_TAG == null'

publish-resources-prod:
  stage: üöö publish
  needs: []
  script:
    - "aws s3 sync resources/ s3://$S3_RESOURCES_BUCKET_PROD/ --exclude '_site/*' --exclude '*/_site/*'"
    - "aws s3 sync resources/_site/ s3://$S3_RESOURCES_BUCKET_PROD/"
  environment:
    name: resources-prod
    url: "http://$S3_RESOURCES_BUCKET_PROD"
  rules:
    - changes:
        - 'resources/**/*.*'
      if: $CI_COMMIT_TAG

publish-docs-stage:
  stage: üöö publish
  needs:
    - job: build
      artifacts: true
  script:
    - "aws s3 sync site/build/ s3://$S3_DOCS_BUCKET_STAGE/ --delete"
  environment:
    name: docs-testing
    url: "http://$S3_DOCS_BUCKET_STAGE"
  rules:
    -
      changes:
        - 'site/**/*.*'
      if: '$CI_COMMIT_BRANCH != "main" && $CI_COMMIT_TAG == null'
